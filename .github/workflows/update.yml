name: Update Rules Factory

on:
  schedule:
    - cron: '0 20 * * *' # åŒ—äº¬æ—¶é—´å‡Œæ™¨4ç‚¹è‡ªåŠ¨è¿è¡Œ
  workflow_dispatch:     # å…è®¸æ‰‹åŠ¨ç‚¹å‡»è¿è¡Œ

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      # [æ–°å¢æ­¥éª¤] æš´åŠ›æ¸…ç†æ—§æ–‡ä»¶
      # åœ¨ç”Ÿæˆæ–°è§„åˆ™å‰ï¼Œå…ˆæ¸…ç©ºè§„åˆ™ç›®å½•ã€‚
      # è¿™æ ·å¯ä»¥ç¡®ä¿åˆ é™¤æ‰é‚£äº›ä¸å†ä½¿ç”¨çš„"åƒµå°¸æ–‡ä»¶" (å¦‚ Telegram.list)ã€‚
      - name: Clean up old rules
        run: |
          rm -rf rules/clash/*.list
          rm -rf rules/singbox/*.json
          echo "ğŸ§¹ Old rules cleaned up."

      - name: Run processor script
        run: |
          python script/main.py

      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # å°†æ‰€æœ‰å˜åŠ¨ï¼ˆåŒ…æ‹¬åˆ é™¤çš„æ–‡ä»¶å’Œæ–°ç”Ÿæˆçš„æ–‡ä»¶ï¼‰åŠ å…¥æš‚å­˜åŒº
          git add .
          
          # æäº¤æ›´æ”¹
          git diff --quiet && git diff --staged --quiet || (git commit -m "Auto-update: Clean & Regenerate rules $(date +'%Y-%m-%d')" && git push)
